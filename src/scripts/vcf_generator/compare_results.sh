#!/bin/bash
#
# Compare results of current test run and previous test run.
#
set -e
set -u
set -o pipefail


EXACT=""
FUZZY=""
MISSING=""

while getopts 'efm' OPTION; do
  case "$OPTION" in
    e)
      EXACT="-exact"
      ;;

    f)
      FUZZY="-fuzzy"
      ;;

    m)
      MISSING="-missing"
      ;;

    ?)
      echo "script usage: $(basename $0) [-m]" >&2
      exit 1
      ;;
  esac
done
shift "$(($OPTIND -1))"


# cd to location of script
cd $(dirname $0)

if [ -z ${PHARMCAT_DATA_DIR+x} ]; then
  dataDir="../../../build"
else
  # expect PHARMCAT_DATA_DIR to be a relative directory
  dataDir="../../../${PHARMCAT_DATA_DIR}"
fi

oldFile="../../../src/test/autogenerated/autogenerated_test_report${EXACT}${FUZZY}${MISSING}.txt"
newFile="${dataDir}/autogeneratedTestResults/autogenerated_test_report.txt"

OLD=`grep "# failed" ${oldFile}`
NEW=`grep "# failed" ${newFile}`


if [[ $OLD != $NEW ]]; then
  echo ""
  echo "Test result mismatch!"
  echo "OLD: $OLD"
  echo "NEW: $NEW"
  echo ""
  exit 1
else
  echo ""
  echo ""
  echo "=====> NO CHANGE TO RESULTS <====="
  echo ""
  echo ""
  rm $oldFile
  grep -v Elapsed $newFile > $oldFile
fi
